---
# Playbook pour rÃ©initialiser le cluster (supprime tout)
# âš ï¸  ATTENTION: Ce playbook supprime complÃ¨tement le cluster !
# Usage: ansible-playbook -i inventories/terraform_inventory.yml playbooks/reset.yml

- name: "ğŸš¨ ATTENTION: RÃ©initialisation complÃ¨te du cluster"
  hosts: all
  become: yes
  
  vars_prompt:
    - name: confirm_reset
      prompt: "âš ï¸  ÃŠtes-vous sÃ»r de vouloir rÃ©initialiser le cluster ? (tapez 'yes' pour confirmer)"
      private: no
      
  tasks:
    - name: "ğŸ›‘ ArrÃªt si confirmation non donnÃ©e"
      fail:
        msg: "âŒ RÃ©initialisation annulÃ©e par l'utilisateur"
      when: confirm_reset != "yes"

- name: "ğŸ—„ï¸ RÃ©initialisation des nÅ“uds worker"
  hosts: workers
  become: yes
  serial: 1
  
  tasks:
    - name: "ğŸ”„ Reset du nÅ“ud worker"
      command: kubeadm reset --force
      ignore_errors: yes
      
    - name: "ğŸ§¹ Nettoyage des rÃ©pertoires Kubernetes"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
        - /etc/cni/net.d
        - /home/ubuntu/.kube

- name: "ğŸ›ï¸ RÃ©initialisation du master"
  hosts: masters
  become: yes
  
  tasks:
    - name: "ğŸ”„ Reset du master"
      command: kubeadm reset --force
      ignore_errors: yes
      
    - name: "ğŸ§¹ Nettoyage des rÃ©pertoires Kubernetes"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
        - /etc/cni/net.d
        - /home/ubuntu/.kube
        - /root/.kube

- name: "ğŸ§¹ Nettoyage complet de tous les nÅ“uds"
  hosts: all
  become: yes
  
  tasks:
    - name: "ğŸ”„ Restart de kubelet"
      systemd:
        name: kubelet
        state: restarted
      ignore_errors: yes
      
    - name: "ğŸ”„ Restart de containerd"
      systemd:
        name: containerd
        state: restarted
        
    - name: "ğŸ§¹ Suppression des images containers"
      shell: crictl rmi --all
      ignore_errors: yes
      
    - name: "ğŸ§¹ Nettoyage des pods"
      shell: crictl rmp --all
      ignore_errors: yes
      
    - name: "âœ… Cluster rÃ©initialisÃ©"
      debug:
        msg: |
          ğŸ‰ Le cluster a Ã©tÃ© complÃ¨tement rÃ©initialisÃ© !
          
          ğŸ”„ Prochaines Ã©tapes :
          1. Relancez le dÃ©ploiement avec site.yml
          2. Ou modifiez la configuration avant redÃ©ploiement