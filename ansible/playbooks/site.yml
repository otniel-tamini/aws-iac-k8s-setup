---
# Playbook principal pour le déploiement du cluster Kubernetes
# Usage: ansible-playbook -i inventories/terraform_inventory.yml playbooks/site.yml

- name: "🚀 Déploiement complet du cluster Kubernetes sur AWS"
  hosts: all
  become: yes
  gather_facts: yes
  
  pre_tasks:
    - name: "🔍 Vérification de la connectivité"
      ping:
      
    - name: "📋 Affichage des informations du système"
      debug:
        msg: |
          Hôte: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Architecture: {{ ansible_architecture }}
          IP privée: {{ ansible_default_ipv4.address }}

- name: "⚙️ Phase 1: Préparation de tous les nœuds"
  hosts: all
  become: yes
  roles:
    - common
    - kubernetes
  tags:
    - preparation
    - common
    - kubernetes

- name: "🎛️ Phase 2: Initialisation du cluster sur le master"
  hosts: masters
  become: yes
  roles:
    - master
  tags:
    - master
    - cluster-init

- name: "🔗 Phase 3: Jonction des workers au cluster"
  hosts: workers
  become: yes
  roles:
    - worker
  tags:
    - worker
    - cluster-join

- name: "🌐 Phase 4: Installation du CNI (Flannel)"
  hosts: masters
  become: yes
  roles:
    - cni
  tags:
    - cni
    - networking

- name: "✅ Phase 5: Vérification finale du cluster"
  hosts: masters
  become: yes
  tasks:
    - name: "🔍 Vérifier le statut des nœuds"
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false
      
    - name: "📊 Afficher le statut du cluster"
      debug:
        msg: |
          === STATUT DU CLUSTER KUBERNETES ===
          {{ cluster_nodes.stdout }}
          
    - name: "🔍 Vérifier les pods système"
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl get pods -n kube-system
      register: system_pods
      changed_when: false
      
    - name: "📊 Afficher les pods système"
      debug:
        msg: |
          === PODS SYSTÈME ===
          {{ system_pods.stdout }}

    - name: "🎉 Cluster Kubernetes prêt !"
      debug:
        msg: |
          ✅ Le cluster Kubernetes a été déployé avec succès !
          
          🔗 Commandes utiles :
          - Voir les nœuds: kubectl get nodes
          - Voir les pods: kubectl get pods --all-namespaces
          - Configuration kubectl: /etc/kubernetes/admin.conf
          
          🎯 Prochaines étapes :
          - Configurer kubectl sur votre machine locale
          - Déployer vos applications
          - Configurer l'ingress controller (optionnel)
  tags:
    - verification
    - final