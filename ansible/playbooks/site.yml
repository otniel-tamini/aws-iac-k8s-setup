---
# Playbook principal pour le dÃ©ploiement du cluster Kubernetes
# Usage: ansible-playbook -i inventories/terraform_inventory.yml playbooks/site.yml

- name: "ğŸš€ DÃ©ploiement complet du cluster Kubernetes sur AWS"
  hosts: all
  become: yes
  gather_facts: yes
  
  pre_tasks:
    - name: "ğŸ” VÃ©rification de la connectivitÃ©"
      ping:
      
    - name: "ğŸ“‹ Affichage des informations du systÃ¨me"
      debug:
        msg: |
          HÃ´te: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Architecture: {{ ansible_architecture }}
          IP privÃ©e: {{ ansible_default_ipv4.address }}

- name: "âš™ï¸ Phase 1: PrÃ©paration de tous les nÅ“uds"
  hosts: all
  become: yes
  roles:
    - common
    - kubernetes
  tags:
    - preparation
    - common
    - kubernetes

- name: "ğŸ›ï¸ Phase 2: Initialisation du cluster sur le master"
  hosts: masters
  become: yes
  roles:
    - master
  tags:
    - master
    - cluster-init

- name: "ğŸ”— Phase 3: Jonction des workers au cluster"
  hosts: workers
  become: yes
  roles:
    - worker
  tags:
    - worker
    - cluster-join

- name: "ğŸŒ Phase 4: Installation du CNI (Flannel)"
  hosts: masters
  become: yes
  roles:
    - cni
  tags:
    - cni
    - networking

- name: "âœ… Phase 5: VÃ©rification finale du cluster"
  hosts: masters
  become: yes
  tasks:
    - name: "ğŸ” VÃ©rifier le statut des nÅ“uds"
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false
      
    - name: "ğŸ“Š Afficher le statut du cluster"
      debug:
        msg: |
          === STATUT DU CLUSTER KUBERNETES ===
          {{ cluster_nodes.stdout }}
          
    - name: "ğŸ” VÃ©rifier les pods systÃ¨me"
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl get pods -n kube-system
      register: system_pods
      changed_when: false
      
    - name: "ğŸ“Š Afficher les pods systÃ¨me"
      debug:
        msg: |
          === PODS SYSTÃˆME ===
          {{ system_pods.stdout }}

    - name: "ğŸ‰ Cluster Kubernetes prÃªt !"
      debug:
        msg: |
          âœ… Le cluster Kubernetes a Ã©tÃ© dÃ©ployÃ© avec succÃ¨s !
          
          ğŸ”— Commandes utiles :
          - Voir les nÅ“uds: kubectl get nodes
          - Voir les pods: kubectl get pods --all-namespaces
          - Configuration kubectl: /etc/kubernetes/admin.conf
          
          ğŸ¯ Prochaines Ã©tapes :
          - Configurer kubectl sur votre machine locale
          - DÃ©ployer vos applications
          - Configurer l'ingress controller (optionnel)
  tags:
    - verification
    - final