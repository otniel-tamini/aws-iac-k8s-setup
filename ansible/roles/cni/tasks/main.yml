---
# Installation et configuration du CNI (Container Network Interface)

- name: "ğŸ” VÃ©rifier si le CNI est dÃ©jÃ  installÃ©"
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get pods -n kube-system | grep -E "(flannel|calico)" || true
  register: cni_check
  changed_when: false

- name: "ğŸŒ Installation de Flannel CNI"
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
  register: flannel_install
  when: 
    - cni_provider == "flannel"
    - "'flannel' not in cni_check.stdout"

- name: "ğŸŒ Installation de Calico CNI"
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/tigera-operator.yaml
    kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/custom-resources.yaml
  register: calico_install
  when: 
    - cni_provider == "calico"
    - "'calico' not in cni_check.stdout"

- name: "ğŸ“ Afficher le rÃ©sultat de l'installation Flannel"
  debug:
    var: flannel_install.stdout_lines
  when: 
    - flannel_install is defined 
    - flannel_install.stdout_lines is defined

- name: "ğŸ“ Afficher le rÃ©sultat de l'installation Calico"
  debug:
    var: calico_install.stdout_lines
  when: 
    - calico_install is defined 
    - calico_install.stdout_lines is defined

- name: "â³ Attendre que les pods Flannel soient prÃªts"
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl wait --for=condition=ready pod -l app=flannel -n kube-flannel --timeout=300s
  register: flannel_ready
  when: cni_provider == "flannel"
  changed_when: false

- name: "â³ Attendre que les pods Calico soient prÃªts"
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl wait --for=condition=ready pod -l k8s-app=calico-node -n calico-system --timeout=300s
  register: calico_ready
  when: cni_provider == "calico"
  ignore_errors: yes

- name: "ğŸ” VÃ©rifier le statut des nÅ“uds aprÃ¨s installation CNI"
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get nodes -o wide
  register: nodes_status
  changed_when: false

- name: "ğŸ“Š Afficher le statut des nÅ“uds"
  debug:
    msg: |
      ğŸŒ CNI {{ cni_provider | upper }} installÃ© !
      
      ğŸ“Š Statut des nÅ“uds :
      {{ nodes_status.stdout }}

- name: "ğŸ” VÃ©rifier les pods systÃ¨me"
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get pods -n kube-system -o wide
  register: system_pods
  changed_when: false

- name: "ğŸ“Š Afficher les pods systÃ¨me"
  debug:
    msg: |
      ğŸ“¦ Pods systÃ¨me :
      {{ system_pods.stdout }}

- name: "âœ… CNI configurÃ© avec succÃ¨s"
  debug:
    msg: |
      ğŸ‰ Le rÃ©seau {{ cni_provider | upper }} a Ã©tÃ© configurÃ© avec succÃ¨s !
      
      ğŸ“‹ Informations :
      - Provider CNI: {{ cni_provider | upper }}
      - Les nÅ“uds devraient maintenant Ãªtre en Ã©tat "Ready"
      
      ğŸ”§ Le cluster est maintenant prÃªt Ã  dÃ©ployer des applications !