---
# TÃ¢ches communes pour tous les nÅ“uds du cluster Kubernetes

- name: "ğŸ“¦ Mise Ã  jour du cache APT"
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: "ğŸ“¦ Installation des paquets de base"
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - htop
      - vim
      - git
    state: present

- name: "ğŸš« DÃ©sactivation du swap"
  shell: swapoff -a
  
- name: "ğŸš« DÃ©sactivation permanente du swap dans /etc/fstab"
  lineinfile:
    path: /etc/fstab
    regexp: '.*swap.*'
    state: absent

- name: "âš™ï¸ Configuration des modules kernel requis"
  blockinfile:
    path: /etc/modules-load.d/k8s.conf
    create: yes
    block: |
      overlay
      br_netfilter

- name: "âš™ï¸ Chargement des modules kernel"
  modprobe:
    name: "{{ item }}"
  loop:
    - overlay
    - br_netfilter

- name: "âš™ï¸ Configuration sysctl pour Kubernetes"
  blockinfile:
    path: /etc/sysctl.d/k8s.conf
    create: yes
    block: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1

- name: "âš™ï¸ Application des paramÃ¨tres sysctl"
  shell: sysctl --system

- name: "ğŸ³ Ajout de la clÃ© GPG Docker"
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    keyring: /usr/share/keyrings/docker-archive-keyring.gpg
    state: present

- name: "ğŸ³ Ajout du repository Docker"
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present

- name: "ğŸ³ Installation de containerd"
  apt:
    name: containerd.io
    state: present
    update_cache: yes

- name: "ğŸ³ CrÃ©ation du rÃ©pertoire de configuration containerd"
  file:
    path: /etc/containerd
    state: directory
    mode: '0755'

- name: "ğŸ³ VÃ©rifier si la configuration containerd existe"
  stat:
    path: /etc/containerd/config.toml
  register: containerd_config

- name: "ğŸ³ GÃ©nÃ©ration de la configuration par dÃ©faut de containerd"
  shell: containerd config default > /etc/containerd/config.toml
  when: not containerd_config.stat.exists

- name: "ğŸ³ Configuration du driver cgroup systemd pour containerd"
  replace:
    path: /etc/containerd/config.toml
    regexp: 'SystemdCgroup\s*=\s*false'
    replace: 'SystemdCgroup = true'
  register: cgroup_config
  notify: restart containerd

- name: "ğŸ³ VÃ©rifier si la configuration a Ã©tÃ© appliquÃ©e"
  command: grep "SystemdCgroup = true" /etc/containerd/config.toml
  register: cgroup_check
  failed_when: false
  changed_when: false

- name: "ğŸ³ Forcer la rÃ©gÃ©nÃ©ration si SystemdCgroup n'est pas configurÃ©"
  block:
    - name: "ğŸ—‘ï¸ Supprimer l'ancienne configuration"
      file:
        path: /etc/containerd/config.toml
        state: absent
    
    - name: "ğŸ³ RÃ©gÃ©nÃ©rer la configuration containerd"
      shell: containerd config default > /etc/containerd/config.toml
    
    - name: "ğŸ³ Appliquer SystemdCgroup = true"
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup\s*=\s*false'
        replace: 'SystemdCgroup = true'
      notify: restart containerd
  when: cgroup_check.rc != 0

- name: "ğŸ³ S'assurer que containerd est redÃ©marrÃ© immÃ©diatement"
  meta: flush_handlers

- name: "ğŸ³ Activation et dÃ©marrage de containerd"
  systemd:
    name: containerd
    enabled: yes
    state: started

- name: "ğŸ³ VÃ©rification du statut de containerd"
  systemd:
    name: containerd
    state: started
  register: containerd_status

- name: "ğŸ³ Attendre que containerd soit prÃªt"
  wait_for:
    path: /var/run/containerd/containerd.sock
    timeout: 30

- name: "ğŸ·ï¸ Configuration du hostname"
  hostname:
    name: "{{ inventory_hostname }}"

- name: "ğŸ·ï¸ Mise Ã  jour de /etc/hosts"
  lineinfile:
    path: /etc/hosts
    line: "127.0.0.1 {{ inventory_hostname }}"
    state: present

- name: "ğŸ“ CrÃ©ation du rÃ©pertoire des logs Kubernetes"
  file:
    path: /var/log/kubernetes
    state: directory
    mode: '0755'