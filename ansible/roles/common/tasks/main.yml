---
# Tâches communes pour tous les nœuds du cluster Kubernetes

- name: "📦 Mise à jour du cache APT"
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: "📦 Installation des paquets de base"
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - htop
      - vim
      - git
    state: present

- name: "🚫 Désactivation du swap"
  shell: swapoff -a
  
- name: "🚫 Désactivation permanente du swap dans /etc/fstab"
  lineinfile:
    path: /etc/fstab
    regexp: '.*swap.*'
    state: absent

- name: "⚙️ Configuration des modules kernel requis"
  blockinfile:
    path: /etc/modules-load.d/k8s.conf
    create: yes
    block: |
      overlay
      br_netfilter

- name: "⚙️ Chargement des modules kernel"
  modprobe:
    name: "{{ item }}"
  loop:
    - overlay
    - br_netfilter

- name: "⚙️ Configuration sysctl pour Kubernetes"
  blockinfile:
    path: /etc/sysctl.d/k8s.conf
    create: yes
    block: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1

- name: "⚙️ Application des paramètres sysctl"
  shell: sysctl --system

- name: "🐳 Ajout de la clé GPG Docker"
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    keyring: /usr/share/keyrings/docker-archive-keyring.gpg
    state: present

- name: "🐳 Ajout du repository Docker"
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present

- name: "🐳 Installation de containerd"
  apt:
    name: containerd.io
    state: present
    update_cache: yes

- name: "🐳 Création du répertoire de configuration containerd"
  file:
    path: /etc/containerd
    state: directory

- name: "🐳 Génération de la configuration par défaut de containerd"
  shell: containerd config default > /etc/containerd/config.toml
  args:
    creates: /etc/containerd/config.toml

- name: "🐳 Configuration du driver cgroup systemd pour containerd"
  replace:
    path: /etc/containerd/config.toml
    regexp: 'SystemdCgroup = false'
    replace: 'SystemdCgroup = true'
  notify: restart containerd

- name: "🐳 S'assurer que containerd est redémarré immédiatement"
  meta: flush_handlers

- name: "🐳 Activation et démarrage de containerd"
  systemd:
    name: containerd
    enabled: yes
    state: started

- name: "🐳 Vérification du statut de containerd"
  systemd:
    name: containerd
    state: started
  register: containerd_status

- name: "🐳 Attendre que containerd soit prêt"
  wait_for:
    path: /var/run/containerd/containerd.sock
    timeout: 30

- name: "🏷️ Configuration du hostname"
  hostname:
    name: "{{ inventory_hostname }}"

- name: "🏷️ Mise à jour de /etc/hosts"
  lineinfile:
    path: /etc/hosts
    line: "127.0.0.1 {{ inventory_hostname }}"
    state: present

- name: "📁 Création du répertoire des logs Kubernetes"
  file:
    path: /var/log/kubernetes
    state: directory
    mode: '0755'