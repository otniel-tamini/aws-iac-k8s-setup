---
# Initialisation du cluster Kubernetes sur le nÅ“ud master

- name: "ğŸ” VÃ©rifier si le cluster est dÃ©jÃ  initialisÃ©"
  stat:
    path: /etc/kubernetes/admin.conf
  register: cluster_initialized

- name: "ğŸš€ Initialisation du cluster Kubernetes"
  command: >
    kubeadm init
    --pod-network-cidr={{ pod_network_cidr }}
    --service-cidr={{ service_cidr }}
    --apiserver-advertise-address={{ ansible_default_ipv4.address }}
    --node-name={{ inventory_hostname }}
    --ignore-preflight-errors=NumCPU,Mem
  register: kubeadm_init
  when: not cluster_initialized.stat.exists

- name: "ğŸ“ Afficher le rÃ©sultat de l'initialisation"
  debug:
    var: kubeadm_init.stdout_lines
  when: kubeadm_init is defined and kubeadm_init.stdout_lines is defined

- name: "ğŸ”‘ CrÃ©er le rÃ©pertoire .kube pour l'utilisateur ubuntu"
  file:
    path: /home/ubuntu/.kube
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: "ğŸ”‘ Copier la configuration kubectl pour ubuntu"
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/ubuntu/.kube/config
    owner: ubuntu
    group: ubuntu
    mode: '0644'
    remote_src: yes

- name: "ğŸ”‘ CrÃ©er le rÃ©pertoire .kube pour root"
  file:
    path: /root/.kube
    state: directory
    mode: '0755'

- name: "ğŸ”‘ Copier la configuration kubectl pour root"
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    mode: '0644'
    remote_src: yes

- name: "ğŸ« GÃ©nÃ©rer le token de jointure"
  command: kubeadm token create --print-join-command
  register: join_command
  changed_when: false

- name: "ğŸ“ Sauvegarder la commande de jointure"
  copy:
    content: "{{ join_command.stdout }}"
    dest: /tmp/kubernetes_join_command.sh
    mode: '0755'

- name: "ğŸ“¥ RÃ©cupÃ©rer la commande de jointure"
  fetch:
    src: /tmp/kubernetes_join_command.sh
    dest: /tmp/
    flat: yes

- name: "ğŸ“Š Afficher la commande de jointure"
  debug:
    msg: |
      ğŸ« Commande de jointure gÃ©nÃ©rÃ©e :
      {{ join_command.stdout }}

- name: "â³ Attendre que l'API server soit prÃªt"
  uri:
    url: "https://{{ ansible_default_ipv4.address }}:6443/healthz"
    method: GET
    validate_certs: no
  register: api_health
  until: api_health.status == 200
  retries: 30
  delay: 10

- name: "âœ… Cluster master initialisÃ© avec succÃ¨s"
  debug:
    msg: |
      ğŸ‰ Le cluster Kubernetes a Ã©tÃ© initialisÃ© avec succÃ¨s !
      
      ğŸ“‹ Informations importantes :
      - API Server: https://{{ ansible_default_ipv4.address }}:6443
      - Configuration kubectl: /etc/kubernetes/admin.conf
      - Commande de jointure sauvegardÃ©e dans /tmp/kubernetes_join_command.sh
      
      ğŸ”§ Prochaines Ã©tapes :
      1. Les workers vont maintenant rejoindre le cluster
      2. Le CNI sera installÃ©
      3. Le cluster sera prÃªt Ã  utiliser