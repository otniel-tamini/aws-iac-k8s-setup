---
# Jointure des nÅ“uds worker au cluster Kubernetes

- name: "ğŸ” VÃ©rifier si le nÅ“ud a dÃ©jÃ  rejoint le cluster"
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: node_joined

- name: "ğŸ“¥ Copier la commande de jointure depuis le master"
  copy:
    src: /tmp/kubernetes_join_command.sh
    dest: /tmp/kubernetes_join_command.sh
    mode: '0755'
  when: not node_joined.stat.exists

- name: "ğŸ”— Joindre le nÅ“ud worker au cluster"
  shell: /tmp/kubernetes_join_command.sh
  register: join_result
  when: not node_joined.stat.exists

- name: "ğŸ“ Afficher le rÃ©sultat de la jointure"
  debug:
    var: join_result.stdout_lines
  when: join_result is defined and join_result.stdout_lines is defined

- name: "â³ Attendre que kubelet soit actif"
  systemd:
    name: kubelet
    state: started
  register: kubelet_status
  until: kubelet_status.status.ActiveState == "active"
  retries: 10
  delay: 10

- name: "ğŸ§¹ Nettoyer le fichier de jointure"
  file:
    path: /tmp/kubernetes_join_command.sh
    state: absent

- name: "âœ… Worker rejoint le cluster avec succÃ¨s"
  debug:
    msg: |
      ğŸ‰ Le nÅ“ud worker {{ inventory_hostname }} a rejoint le cluster !
      
      ğŸ“‹ Informations :
      - Kubelet: {{ kubelet_status.status.ActiveState }}
      - Configuration: /etc/kubernetes/kubelet.conf
      
      ğŸ”§ Le nÅ“ud est maintenant prÃªt Ã  recevoir des pods.